{"version":3,"sources":["../../../node_modules/next/dist/esm/build/templates/app-route.js","../../../src/app/api/analyze-safety/route.ts","../../../src/lib/site-guardian.ts"],"sourcesContent":["import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setReferenceManifestsSingleton } from \"next/dist/esm/server/app-render/encryption-utils\";\nimport { createServerModuleMap } from \"next/dist/esm/server/app-render/action-utils\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/analyze-safety/route\",\n        pathname: \"/api/analyze-safety\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/src/app/api/analyze-safety/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/analyze-safety/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setReferenceManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest,\n            serverModuleMap: createServerModuleMap({\n                serverActionsManifest\n            })\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext)=>routeModule.onRequestError(req, error, errorContext, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            });\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n","import { NextRequest, NextResponse } from 'next/server';\nimport { GoogleGenerativeAI } from '@google/generative-ai';\nimport { INTERVENTION_SCRIPTS, getAudioLevel, type SafetyAnalysis, type Worker, type ZoneType } from '@/lib/site-guardian';\n\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY || 'AIzaSyDjnsgbo5yc2iroteGTz5qVe0DvruZxS2M';\nconst genAI = new GoogleGenerativeAI(GEMINI_API_KEY);\n\n// MODEL CONFIGURATION - Update this based on your API key's available models\n// Try: 'gemini-2.5-flash', 'gemini-1.5-flash', 'gemini-1.5-pro', or 'gemini-pro'\n// Visit /api/test-models to see which models work with your API key\nconst MODEL_NAME = 'gemini-2.5-flash';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const formData = await request.formData();\n    const file = formData.get('video') as File | null;\n    const frameImage = formData.get('frame') as string | null;\n    const zoneMap = formData.get('zoneMap') as string | null; // Optional zone configuration\n    \n    if (!file && !frameImage) {\n      return NextResponse.json({ error: 'No video file or frame provided' }, { status: 400 });\n    }\n\n    // Use the configured model name (defined at top of file)\n    const model = genAI.getGenerativeModel({ model: MODEL_NAME });\n    \n    let imageData: string;\n    let mimeType: string;\n\n    if (frameImage) {\n      imageData = frameImage.replace(/^data:image\\/\\w+;base64,/, '');\n      mimeType = 'image/jpeg';\n    } else if (file) {\n      const arrayBuffer = await file.arrayBuffer();\n      const buffer = Buffer.from(arrayBuffer);\n      imageData = buffer.toString('base64');\n      mimeType = file.type || 'video/mp4';\n      \n      if (file.size > 20 * 1024 * 1024) {\n        return NextResponse.json({ \n          error: 'Video file too large. Please extract a frame on the client side or use a smaller video.' \n        }, { status: 400 });\n      }\n    } else {\n      return NextResponse.json({ error: 'No valid file or frame provided' }, { status: 400 });\n    }\n\n    // Site Guardian Analysis Prompt\n    const prompt = `You are SITE GUARDIAN, an autonomous Computer Vision Safety System for construction sites.\n\nAnalyze this video frame with MAXIMUM SAFETY FOCUS. Identify ALL safety violations and potential hazards.\n\nLAYER A - PPE COMPLIANCE:\n\nSTEP 1: IDENTIFY ACTUAL HUMAN HEADS (BE VERY CAREFUL):\n\nA human head must satisfy ALL these criteria:\nâœ“ Visible connection to a human body (head on shoulders/neck)\nâœ“ Clear position in the image where head/face would be\nâœ“ Sufficient clarity to determine head covering type\nâœ“ Not a random object, shadow, or background element\n\nDO NOT count as a head if:\nâœ— Too far away to clearly see head structure\nâœ— Blurry or unclear head position\nâœ— Partial view where head position is ambiguous\nâœ— Random objects mistaken for heads\nâœ— Shadows or reflections\nâœ— Only see body without clear head position\n\nSTEP 2: For EACH VALID HUMAN HEAD, classify the head covering:\n\nHEAD COVERING CLASSIFICATION:\n\n1. HARD_HAT/HELMET (COMPLIANT - hardHat: true, headCovering: \"HARD_HAT\"):\n   âœ“ ANY protective helmet/headgear that could protect from impact\n   âœ“ Safety helmets (construction): hard plastic, often has brim, smooth surface\n   âœ“ Motorcycle/bike helmets: full face, half, or open face - ANY COLOR (red, black, white, etc.)\n   âœ“ Industrial helmets: hard shell material\n   âœ“ Key indicator: Hard material (plastic/composite), protective structure\n   âœ“ CRITICAL: Red helmets, black helmets, ANY COLOR helmet = HARD_HAT (not BARE_HEAD)\n\n2. TURBAN (NOT COMPLIANT - hardHat: false, headCovering: \"TURBAN\"):\n   âœ“ Fabric cloth wrapped around head in distinctive pattern\n   âœ“ Shows cloth/fabric texture (not hard plastic)\n   âœ“ Can be white, black, blue, orange, various colors\n   âœ“ Soft fabric material, often shows wrapped layers\n   âœ“ Covers entire head area but is clearly fabric\n\n3. MUSLIM_TAQIYAH/SKULLCAP (NOT COMPLIANT - hardHat: false, headCovering: \"MUSLIM_TAQIYAH\"):\n   âœ“ Small rounded cap sitting on top of head\n   âœ“ Usually white, can be colored\n   âœ“ Only covers crown/top of head\n   âœ“ Fabric material, smaller than helmet\n   âœ“ Doesn't fully protect like a hard hat\n\n4. BARE_HEAD (VIOLATION - hardHat: false, headCovering: \"BARE_HEAD\"):\n   âœ“ Visible hair of any color or texture\n   âœ“ Visible scalp/skin on head\n   âœ“ NO head covering visible at all\n   âœ“ Head is completely exposed\n\nSTEP 3: FACE COORDINATES (ONLY for non-compliant workers):\n\nIMPORTANT RULES:\n- ONLY provide faceCoordinates if:\n  * Worker has BARE_HEAD, TURBAN, or MUSLIM_TAQIYAH (not compliant)\n  * You can CLEARLY see where the head/face is located (90%+ confidence)\n  * Head position is unambiguous in the image\n  \n- DO NOT provide faceCoordinates if:\n  * Head position is unclear or uncertain\n  * Person is too far away\n  * Head is partially obscured or ambiguous\n\nFace coordinate calculation (percentages 0-100):\n- x: Horizontal center of head in image (0 = left edge, 100 = right edge)\n- y: Vertical top of head in image (0 = top edge, 100 = bottom edge)\n- width: Width of head area (12-22% of image width typical)\n- height: Height of head from top to chin (15-25% of image height typical)\n\nFor accurate coordinates:\n- Look at where the head actually is in relation to the person's body\n- Head is typically at the top of the person's visible body\n- Center horizontally based on person's body position\n- If uncertain, leave faceCoordinates as null\n\nAlso check:\n- SAFETY_VEST: High-visibility Yellow/Orange vest\n- PROTECTIVE_BOOTS: Steel-toe boots\n- SAFETY_GLASSES: If in grinding/cutting zones\n- EAR_PROTECTION: If near loud machinery\n- HARNESS: If working at height (>6ft)\n\nLAYER B - ZONAL AWARENESS:\n- ZONE_GREEN: Safe walkways, break areas\n- ZONE_YELLOW: Active work areas (PPE Mandatory)\n- ZONE_RED: High Danger (excavator swing radius, open pits, electrical panels)\n- ZONE_BLACK: No-Go Zones (blast radius, chemical storage)\n\nLAYER C - BEHAVIORAL ANALYSIS:\n- RUSHING: Moving too fast near hazards (>2.5m/s)\n- DISTRACTED: Head down + phone while walking\n- MAN_DOWN: Horizontal posture for >5 seconds (MEDICAL EMERGENCY)\n- ILLEGAL_RIDE: Riding on unauthorized machinery parts\n\nFor each violation detected, identify:\n1. Worker description (clothing color, position)\n2. Missing PPE items\n3. Current zone location\n4. Behavioral risks\n5. Severity (CRITICAL/WARNING/CLEAR)\n6. Face location coordinates (x, y, width, height as percentages 0-100)\n\nFACE COORDINATES - ONLY PROVIDE IF:\n- Worker has BARE_HEAD, TURBAN, or MUSLIM_TAQIYAH (non-compliant)\n- You can clearly see the head/face location\n- You are confident (80%+) about the coordinate position\n- If uncertain, leave faceCoordinates as null or omit it\n\nRespond in JSON format ONLY:\n{\n  \"status\": \"ðŸ”´ CRITICAL DANGER\" | \"ðŸŸ¡ WARNING\" | \"ðŸŸ¢ CLEAR\",\n  \"workers\": [\n    {\n      \"description\": \"Worker in blue shirt near excavator\",\n      \"ppe\": {\n        \"hardHat\": true/false,\n        \"headCovering\": \"HARD_HAT\" | \"TURBAN\" | \"MUSLIM_TAQIYAH\" | \"BARE_HEAD\" | \"UNKNOWN\",\n        \"safetyVest\": true/false,\n        \"protectiveBoots\": true/false,\n        \"safetyGlasses\": true/false,\n        \"earProtection\": true/false,\n        \"harness\": true/false\n      },\n      \"zone\": \"ZONE_GREEN\" | \"ZONE_YELLOW\" | \"ZONE_RED\" | \"ZONE_BLACK\",\n      \"behavior\": {\n        \"rushing\": true/false,\n        \"distracted\": true/false,\n        \"manDown\": true/false,\n        \"illegalRide\": true/false\n      },\n      \"violations\": [\"MISSING_HARD_HAT\", \"IN_DANGER_ZONE\", etc.],\n      \"faceCoordinates\": {\n        \"x\": 45.0,\n        \"y\": 15.0,\n        \"width\": 15.0,\n        \"height\": 18.0\n      } OR null if head position uncertain\n    }\n  ],\n  \"analysis\": [\"Bullet point 1\", \"Bullet point 2\", \"Bullet point 3\"],\n  \"primaryViolation\": \"MISSING_HARD_HAT\" | \"DANGER_ZONE_ENTRY\" | \"MAN_DOWN\" | etc.,\n  \"urgency\": \"CRITICAL\" | \"HIGH\" | \"MEDIUM\" | \"LOW\"\n}\n\nFormat the analysis as an array of bullet points. Face coordinates are percentages (0-100) of image dimensions.`;\n\n    const contentPart = {\n      inlineData: {\n        data: imageData,\n        mimeType: mimeType,\n      },\n    };\n\n    console.log('SITE GUARDIAN: Analyzing frame for safety violations...');\n    \n    try {\n      const result = await model.generateContent([prompt, contentPart]);\n      const response = await result.response;\n      const text = response.text();\n      console.log('SITE GUARDIAN: Analysis received');\n      \n      // Parse JSON response\n      let analysisData: any;\n      try {\n        const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n        if (jsonMatch) {\n          analysisData = JSON.parse(jsonMatch[0]);\n        } else {\n          throw new Error('No JSON found in response');\n        }\n      } catch (parseError) {\n        console.error('Error parsing analysis:', parseError);\n        // Fallback analysis\n        // Convert text to bullet points if not already an array\n        const bulletPoints = text.split('\\n').filter(line => line.trim().length > 0);\n        analysisData = {\n          status: 'ðŸŸ¢ CLEAR',\n          workers: [],\n          analysis: bulletPoints.length > 0 ? bulletPoints : [text],\n          primaryViolation: null,\n          urgency: 'LOW'\n        };\n      }\n\n      // Generate intervention script\n      const workers: Worker[] = (analysisData.workers || []).map((w: any) => {\n        const headCovering = w.ppe?.headCovering || \n          (w.ppe?.hardHat === true ? 'HARD_HAT' : 'BARE_HEAD');\n        const hasHardHat = headCovering === 'HARD_HAT';\n        const needsPrivacyBlur = !hasHardHat && (headCovering === 'BARE_HEAD' || headCovering === 'TURBAN' || headCovering === 'MUSLIM_TAQIYAH');\n        \n        return {\n          description: w.description || 'Unknown worker',\n          ppe: {\n            hardHat: hasHardHat,\n            headCovering: headCovering as any,\n            safetyVest: w.ppe?.safetyVest || false,\n            protectiveBoots: w.ppe?.protectiveBoots || false,\n            safetyGlasses: w.ppe?.safetyGlasses || false,\n            earProtection: w.ppe?.earProtection || false,\n            harness: w.ppe?.harness || false,\n          },\n          zone: w.zone || 'ZONE_YELLOW',\n          compliance: !w.violations || w.violations.length === 0,\n          behavior: w.behavior || {\n            rushing: false,\n            distracted: false,\n            manDown: false,\n            illegalRide: false,\n          },\n          // Only use provided face coordinates if they exist and are valid\n        // Don't generate default coordinates - only use what AI provides\n        faceCoordinates: (w.faceCoordinates && \n          typeof w.faceCoordinates.x === 'number' &&\n          typeof w.faceCoordinates.y === 'number' &&\n          typeof w.faceCoordinates.width === 'number' &&\n          typeof w.faceCoordinates.height === 'number' &&\n          needsPrivacyBlur) ? w.faceCoordinates : undefined,\n        };\n      });\n\n      // Determine action and voice output\n      let action = 'MONITOR';\n      let voiceOutput = '';\n      let audioLevel: string | undefined;\n\n      const violations = analysisData.primaryViolation || '';\n      const urgency = analysisData.urgency || 'LOW';\n      const worker = workers[0]; // Primary worker of concern\n\n      if (analysisData.primaryViolation || urgency === 'CRITICAL' || urgency === 'HIGH') {\n        if (violations.includes('MAN_DOWN') || worker?.behavior?.manDown) {\n          action = 'TRIGGER EMERGENCY_ALARM';\n          audioLevel = 'EMERGENCY_ALARM';\n          voiceOutput = INTERVENTION_SCRIPTS.manDown.replace('{ZONE}', worker?.zone || 'SECTOR');\n        } else if (violations.includes('MISSING_HARD_HAT') || !worker?.ppe.hardHat || \n                   worker?.ppe.headCovering === 'BARE_HEAD' || \n                   worker?.ppe.headCovering === 'TURBAN' || \n                   worker?.ppe.headCovering === 'MUSLIM_TAQIYAH') {\n          action = 'TRIGGER SCRIPT_PPE_HAT';\n          audioLevel = getAudioLevel(worker?.zone || 'ZONE_YELLOW', 'MISSING_HARD_HAT');\n          voiceOutput = INTERVENTION_SCRIPTS.ppeHat.replace('{WORKER}', worker?.description || 'WORKER');\n        } else if (violations.includes('MISSING_VEST') || !worker?.ppe.safetyVest) {\n          action = 'TRIGGER SCRIPT_PPE_VEST';\n          audioLevel = getAudioLevel(worker?.zone || 'ZONE_YELLOW', 'MISSING_VEST');\n          voiceOutput = INTERVENTION_SCRIPTS.ppeVest;\n        } else if (violations.includes('DANGER_ZONE') || worker?.zone === 'ZONE_RED') {\n          action = 'TRIGGER SCRIPT_DANGER_ZONE';\n          audioLevel = 'AUDIO_LEVEL_3';\n          voiceOutput = INTERVENTION_SCRIPTS.dangerZone;\n        } else if (violations.includes('FALL_RISK') || (!worker?.ppe.harness && worker?.zone === 'ZONE_YELLOW')) {\n          action = 'TRIGGER SCRIPT_FALL_RISK';\n          audioLevel = getAudioLevel(worker?.zone || 'ZONE_YELLOW', 'FALL_RISK');\n          voiceOutput = INTERVENTION_SCRIPTS.fallRisk;\n        } else if (worker?.behavior?.distracted) {\n          action = 'TRIGGER SCRIPT_DISTRACTION';\n          audioLevel = 'AUDIO_LEVEL_2';\n          voiceOutput = INTERVENTION_SCRIPTS.distraction;\n        } else {\n          action = 'TRIGGER AUDIO_LEVEL_1';\n          const analysisText = Array.isArray(analysisData.analysis) \n            ? analysisData.analysis.join('. ') \n            : analysisData.analysis || 'Safety violation detected';\n          voiceOutput = `SAFETY VIOLATION DETECTED. ${analysisText}`;\n        }\n      }\n\n      // Convert analysis to array format (bullet points)\n      let analysisBullets: string[] = [];\n      if (Array.isArray(analysisData.analysis)) {\n        analysisBullets = analysisData.analysis;\n      } else if (typeof analysisData.analysis === 'string') {\n        // Split by newlines or periods to create bullet points\n        analysisBullets = analysisData.analysis\n          .split(/\\n|\\. /)\n          .filter((point: string) => point.trim().length > 0)\n          .map((point: string) => point.trim().replace(/^[-â€¢]\\s*/, ''));\n      } else {\n        analysisBullets = ['No issues detected'];\n      }\n\n      const safetyAnalysis: SafetyAnalysis = {\n        status: analysisData.status || 'ðŸŸ¢ CLEAR',\n        detected: workers,\n        analysis: analysisBullets.length > 0 ? analysisBullets : ['No issues detected'],\n        action: action,\n        voiceOutput: voiceOutput || 'Area clear. Continue monitoring.',\n        audioLevel: audioLevel as any,\n        timestamp: new Date().toISOString(),\n      };\n\n      return NextResponse.json(safetyAnalysis);\n    } catch (geminiError: any) {\n      console.error('SITE GUARDIAN API error:', geminiError);\n      let errorMessage = 'Failed to analyze safety frame';\n      \n      if (geminiError.message) {\n        errorMessage += `: ${geminiError.message}`;\n      }\n      \n      if (geminiError.message?.includes('API_KEY')) {\n        errorMessage = 'Invalid or missing Gemini API key. Please check your GEMINI_API_KEY environment variable.';\n      } else if (geminiError.message?.includes('not found') || geminiError.message?.includes('404')) {\n        // Model not found - provide clear instructions\n        errorMessage = `Model \"${MODEL_NAME}\" not available with your API key. `;\n        errorMessage += `Please update MODEL_NAME in src/app/api/analyze-safety/route.ts (line ~23) to one of: `;\n        errorMessage += `gemini-1.5-flash, gemini-1.5-pro, or gemini-pro. `;\n        errorMessage += `Visit /api/test-models to see which models are available. `;\n        errorMessage += `Error: ${geminiError.message}`;\n      }\n      \n      return NextResponse.json(\n        { \n          error: errorMessage, \n          details: geminiError.message,\n          suggestion: 'Try using a different model name in the API route. Available models vary by API key access level.'\n        },\n        { status: 500 }\n      );\n    }\n  } catch (error: any) {\n    console.error('SITE GUARDIAN route error:', error);\n    return NextResponse.json(\n      { error: 'Failed to analyze safety frame', details: error.message || 'Unknown error' },\n      { status: 500 }\n    );\n  }\n}\n\n","// Site Guardian Core System Types and Utilities\n\nexport type ZoneType = 'ZONE_GREEN' | 'ZONE_YELLOW' | 'ZONE_RED' | 'ZONE_BLACK';\nexport type PPEType = 'HARD_HAT' | 'SAFETY_VEST' | 'PROTECTIVE_BOOTS' | 'SAFETY_GLASSES' | 'EAR_PROTECTION' | 'HARNESS';\nexport type AlertStatus = 'ðŸ”´ CRITICAL DANGER' | 'ðŸŸ¡ WARNING' | 'ðŸŸ¢ CLEAR';\nexport type AudioLevel = 'AUDIO_LEVEL_1' | 'AUDIO_LEVEL_2' | 'AUDIO_LEVEL_3' | 'EMERGENCY_ALARM';\n\nexport type HeadCoveringType = 'HARD_HAT' | 'TURBAN' | 'MUSLIM_TAQIYAH' | 'BARE_HEAD' | 'UNKNOWN';\n\nexport interface Worker {\n  id?: string;\n  description: string;\n  ppe: {\n    hardHat: boolean;\n    headCovering?: HeadCoveringType;\n    safetyVest: boolean;\n    protectiveBoots: boolean;\n    safetyGlasses: boolean;\n    earProtection: boolean;\n    harness: boolean;\n  };\n  zone: ZoneType;\n  compliance: boolean;\n  behavior?: {\n    rushing: boolean;\n    distracted: boolean;\n    manDown: boolean;\n    illegalRide: boolean;\n  };\n  faceCoordinates?: {\n    x: number; // percentage 0-100\n    y: number; // percentage 0-100\n    width: number; // percentage 0-100\n    height: number; // percentage 0-100\n  };\n}\n\nexport interface SafetyAnalysis {\n  status: AlertStatus;\n  detected: Worker[];\n  analysis: string[]; // Array of bullet points\n  action: string;\n  voiceOutput: string;\n  audioLevel?: AudioLevel;\n  timestamp: string;\n}\n\nexport interface InterventionScript {\n  ppeHat: string;\n  ppeVest: string;\n  dangerZone: string;\n  fallRisk: string;\n  distraction: string;\n  manDown: string;\n}\n\nexport const INTERVENTION_SCRIPTS: InterventionScript = {\n  ppeHat: \"ATTENTION {WORKER}. YOU ARE IN A HARD HAT ZONE. STOP IMMEDIATELY AND PUT ON YOUR HELMET.\",\n  ppeVest: \"SAFETY VIOLATION DETECTED. HIGH-VISIBILITY VEST REQUIRED IN THIS SECTOR. RETURN TO SAFETY ZONE IMMEDIATELY.\",\n  dangerZone: \"WARNING! WARNING! YOU HAVE ENTERED THE EXCAVATOR SWING RADIUS. MOVE BACK. MOVE BACK NOW.\",\n  fallRisk: \"ALERT. YOU ARE WORKING AT HEIGHT WITHOUT A CLIPPED HARNESS. ANCHOR YOUR LINE NOW.\",\n  distraction: \"EYES UP. PHONE DOWN. PAY ATTENTION TO THE FORKLIFT CROSSING.\",\n  manDown: \"MEDICAL EMERGENCY IN {ZONE}. CLEAR THE AREA. DISPATCH SITE_MEDIC.\",\n};\n\nexport function getAudioLevel(zone: ZoneType, violationType: string): AudioLevel {\n  if (violationType === 'MAN_DOWN') return 'EMERGENCY_ALARM';\n  if (zone === 'ZONE_RED') return 'AUDIO_LEVEL_3';\n  if (zone === 'ZONE_BLACK') return 'AUDIO_LEVEL_3';\n  if (zone === 'ZONE_YELLOW') return 'AUDIO_LEVEL_2';\n  return 'AUDIO_LEVEL_1';\n}\n\n"],"names":[],"mappings":"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","ignoreList":[0]}