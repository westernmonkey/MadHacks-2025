module.exports=[12374,e=>{"use strict";var t=e.i(47909),a=e.i(74017),r=e.i(96250),o=e.i(59756),i=e.i(61916),n=e.i(14444),s=e.i(37092),l=e.i(69741),d=e.i(16795),c=e.i(87718),u=e.i(95169),E=e.i(47587),p=e.i(66012),A=e.i(70101),h=e.i(26937),R=e.i(10372),f=e.i(93695);e.i(52474);var I=e.i(220),N=e.i(89171),T=e.i(29642);function O(e,t){return"MAN_DOWN"===t?"EMERGENCY_ALARM":"ZONE_RED"===e||"ZONE_BLACK"===e?"AUDIO_LEVEL_3":"ZONE_YELLOW"===e?"AUDIO_LEVEL_2":"AUDIO_LEVEL_1"}let m=process.env.GEMINI_API_KEY||"AIzaSyDjnsgbo5yc2iroteGTz5qVe0DvruZxS2M",y=new T.GoogleGenerativeAI(m),g="gemini-2.5-flash";async function C(e){try{let t,a,r=await e.formData(),o=r.get("video"),i=r.get("frame");if(r.get("zoneMap"),!o&&!i)return N.NextResponse.json({error:"No video file or frame provided"},{status:400});let n=y.getGenerativeModel({model:g});if(i)t=i.replace(/^data:image\/\w+;base64,/,""),a="image/jpeg";else{if(!o)return N.NextResponse.json({error:"No valid file or frame provided"},{status:400});let e=await o.arrayBuffer();if(t=Buffer.from(e).toString("base64"),a=o.type||"video/mp4",o.size>0x1400000)return N.NextResponse.json({error:"Video file too large. Please extract a frame on the client side or use a smaller video."},{status:400})}let s=`You are SITE GUARDIAN, an autonomous Computer Vision Safety System for construction sites.

Analyze this video frame with MAXIMUM SAFETY FOCUS. Identify ALL safety violations and potential hazards.

LAYER A - PPE COMPLIANCE:

STEP 1: IDENTIFY ACTUAL HUMAN HEADS (BE VERY CAREFUL):

A human head must satisfy ALL these criteria:
âœ“ Visible connection to a human body (head on shoulders/neck)
âœ“ Clear position in the image where head/face would be
âœ“ Sufficient clarity to determine head covering type
âœ“ Not a random object, shadow, or background element

DO NOT count as a head if:
âœ— Too far away to clearly see head structure
âœ— Blurry or unclear head position
âœ— Partial view where head position is ambiguous
âœ— Random objects mistaken for heads
âœ— Shadows or reflections
âœ— Only see body without clear head position

STEP 2: For EACH VALID HUMAN HEAD, classify the head covering:

HEAD COVERING CLASSIFICATION:

1. HARD_HAT/HELMET (COMPLIANT - hardHat: true, headCovering: "HARD_HAT"):
   âœ“ ANY protective helmet/headgear that could protect from impact
   âœ“ Safety helmets (construction): hard plastic, often has brim, smooth surface
   âœ“ Motorcycle/bike helmets: full face, half, or open face - ANY COLOR (red, black, white, etc.)
   âœ“ Industrial helmets: hard shell material
   âœ“ Key indicator: Hard material (plastic/composite), protective structure
   âœ“ CRITICAL: Red helmets, black helmets, ANY COLOR helmet = HARD_HAT (not BARE_HEAD)

2. TURBAN (NOT COMPLIANT - hardHat: false, headCovering: "TURBAN"):
   âœ“ Fabric cloth wrapped around head in distinctive pattern
   âœ“ Shows cloth/fabric texture (not hard plastic)
   âœ“ Can be white, black, blue, orange, various colors
   âœ“ Soft fabric material, often shows wrapped layers
   âœ“ Covers entire head area but is clearly fabric

3. MUSLIM_TAQIYAH/SKULLCAP (NOT COMPLIANT - hardHat: false, headCovering: "MUSLIM_TAQIYAH"):
   âœ“ Small rounded cap sitting on top of head
   âœ“ Usually white, can be colored
   âœ“ Only covers crown/top of head
   âœ“ Fabric material, smaller than helmet
   âœ“ Doesn't fully protect like a hard hat

4. BARE_HEAD (VIOLATION - hardHat: false, headCovering: "BARE_HEAD"):
   âœ“ Visible hair of any color or texture
   âœ“ Visible scalp/skin on head
   âœ“ NO head covering visible at all
   âœ“ Head is completely exposed

STEP 3: FACE COORDINATES (ONLY for non-compliant workers):

IMPORTANT RULES:
- ONLY provide faceCoordinates if:
  * Worker has BARE_HEAD, TURBAN, or MUSLIM_TAQIYAH (not compliant)
  * You can CLEARLY see where the head/face is located (90%+ confidence)
  * Head position is unambiguous in the image
  
- DO NOT provide faceCoordinates if:
  * Head position is unclear or uncertain
  * Person is too far away
  * Head is partially obscured or ambiguous

Face coordinate calculation (percentages 0-100):
- x: Horizontal center of head in image (0 = left edge, 100 = right edge)
- y: Vertical top of head in image (0 = top edge, 100 = bottom edge)
- width: Width of head area (12-22% of image width typical)
- height: Height of head from top to chin (15-25% of image height typical)

For accurate coordinates:
- Look at where the head actually is in relation to the person's body
- Head is typically at the top of the person's visible body
- Center horizontally based on person's body position
- If uncertain, leave faceCoordinates as null

Also check:
- SAFETY_VEST: High-visibility Yellow/Orange vest
- PROTECTIVE_BOOTS: Steel-toe boots
- SAFETY_GLASSES: If in grinding/cutting zones
- EAR_PROTECTION: If near loud machinery
- HARNESS: If working at height (>6ft)

LAYER B - ZONAL AWARENESS:
- ZONE_GREEN: Safe walkways, break areas
- ZONE_YELLOW: Active work areas (PPE Mandatory)
- ZONE_RED: High Danger (excavator swing radius, open pits, electrical panels)
- ZONE_BLACK: No-Go Zones (blast radius, chemical storage)

LAYER C - BEHAVIORAL ANALYSIS:
- RUSHING: Moving too fast near hazards (>2.5m/s)
- DISTRACTED: Head down + phone while walking
- MAN_DOWN: Horizontal posture for >5 seconds (MEDICAL EMERGENCY)
- ILLEGAL_RIDE: Riding on unauthorized machinery parts

For each violation detected, identify:
1. Worker description (clothing color, position)
2. Missing PPE items
3. Current zone location
4. Behavioral risks
5. Severity (CRITICAL/WARNING/CLEAR)
6. Face location coordinates (x, y, width, height as percentages 0-100)

FACE COORDINATES - ONLY PROVIDE IF:
- Worker has BARE_HEAD, TURBAN, or MUSLIM_TAQIYAH (non-compliant)
- You can clearly see the head/face location
- You are confident (80%+) about the coordinate position
- If uncertain, leave faceCoordinates as null or omit it

Respond in JSON format ONLY:
{
  "status": "ðŸ”´ CRITICAL DANGER" | "ðŸŸ¡ WARNING" | "ðŸŸ¢ CLEAR",
  "workers": [
    {
      "description": "Worker in blue shirt near excavator",
      "ppe": {
        "hardHat": true/false,
        "headCovering": "HARD_HAT" | "TURBAN" | "MUSLIM_TAQIYAH" | "BARE_HEAD" | "UNKNOWN",
        "safetyVest": true/false,
        "protectiveBoots": true/false,
        "safetyGlasses": true/false,
        "earProtection": true/false,
        "harness": true/false
      },
      "zone": "ZONE_GREEN" | "ZONE_YELLOW" | "ZONE_RED" | "ZONE_BLACK",
      "behavior": {
        "rushing": true/false,
        "distracted": true/false,
        "manDown": true/false,
        "illegalRide": true/false
      },
      "violations": ["MISSING_HARD_HAT", "IN_DANGER_ZONE", etc.],
      "faceCoordinates": {
        "x": 45.0,
        "y": 15.0,
        "width": 15.0,
        "height": 18.0
      } OR null if head position uncertain
    }
  ],
  "analysis": ["Bullet point 1", "Bullet point 2", "Bullet point 3"],
  "primaryViolation": "MISSING_HARD_HAT" | "DANGER_ZONE_ENTRY" | "MAN_DOWN" | etc.,
  "urgency": "CRITICAL" | "HIGH" | "MEDIUM" | "LOW"
}

Format the analysis as an array of bullet points. Face coordinates are percentages (0-100) of image dimensions.`,l={inlineData:{data:t,mimeType:a}};console.log("SITE GUARDIAN: Analyzing frame for safety violations...");try{let e,t,a=await n.generateContent([s,l]),r=(await a.response).text();console.log("SITE GUARDIAN: Analysis received");try{let t=r.match(/\{[\s\S]*\}/);if(t)e=JSON.parse(t[0]);else throw Error("No JSON found in response")}catch(a){console.error("Error parsing analysis:",a);let t=r.split("\n").filter(e=>e.trim().length>0);e={status:"ðŸŸ¢ CLEAR",workers:[],analysis:t.length>0?t:[r],primaryViolation:null,urgency:"LOW"}}let o=(e.workers||[]).map(e=>{let t=e.ppe?.headCovering||(e.ppe?.hardHat===!0?"HARD_HAT":"BARE_HEAD"),a="HARD_HAT"===t;return{description:e.description||"Unknown worker",ppe:{hardHat:a,headCovering:t,safetyVest:e.ppe?.safetyVest||!1,protectiveBoots:e.ppe?.protectiveBoots||!1,safetyGlasses:e.ppe?.safetyGlasses||!1,earProtection:e.ppe?.earProtection||!1,harness:e.ppe?.harness||!1},zone:e.zone||"ZONE_YELLOW",compliance:!e.violations||0===e.violations.length,behavior:e.behavior||{rushing:!1,distracted:!1,manDown:!1,illegalRide:!1},faceCoordinates:e.faceCoordinates&&"number"==typeof e.faceCoordinates.x&&"number"==typeof e.faceCoordinates.y&&"number"==typeof e.faceCoordinates.width&&"number"==typeof e.faceCoordinates.height&&!a&&("BARE_HEAD"===t||"TURBAN"===t||"MUSLIM_TAQIYAH"===t)?e.faceCoordinates:void 0}}),i="MONITOR",d="",c=e.primaryViolation||"",u=e.urgency||"LOW",E=o[0];if(e.primaryViolation||"CRITICAL"===u||"HIGH"===u)if(c.includes("MAN_DOWN")||E?.behavior?.manDown)i="TRIGGER EMERGENCY_ALARM",t="EMERGENCY_ALARM",d="MEDICAL EMERGENCY IN {ZONE}. CLEAR THE AREA. DISPATCH SITE_MEDIC.".replace("{ZONE}",E?.zone||"SECTOR");else if(c.includes("MISSING_HARD_HAT")||!E?.ppe.hardHat||E?.ppe.headCovering==="BARE_HEAD"||E?.ppe.headCovering==="TURBAN"||E?.ppe.headCovering==="MUSLIM_TAQIYAH")i="TRIGGER SCRIPT_PPE_HAT",t=O(E?.zone||"ZONE_YELLOW","MISSING_HARD_HAT"),d="ATTENTION {WORKER}. YOU ARE IN A HARD HAT ZONE. STOP IMMEDIATELY AND PUT ON YOUR HELMET.".replace("{WORKER}",E?.description||"WORKER");else if(c.includes("MISSING_VEST")||!E?.ppe.safetyVest)i="TRIGGER SCRIPT_PPE_VEST",t=O(E?.zone||"ZONE_YELLOW","MISSING_VEST"),d="SAFETY VIOLATION DETECTED. HIGH-VISIBILITY VEST REQUIRED IN THIS SECTOR. RETURN TO SAFETY ZONE IMMEDIATELY.";else if(c.includes("DANGER_ZONE")||E?.zone==="ZONE_RED")i="TRIGGER SCRIPT_DANGER_ZONE",t="AUDIO_LEVEL_3",d="WARNING! WARNING! YOU HAVE ENTERED THE EXCAVATOR SWING RADIUS. MOVE BACK. MOVE BACK NOW.";else if(c.includes("FALL_RISK")||!E?.ppe.harness&&E?.zone==="ZONE_YELLOW")i="TRIGGER SCRIPT_FALL_RISK",t=O(E?.zone||"ZONE_YELLOW","FALL_RISK"),d="ALERT. YOU ARE WORKING AT HEIGHT WITHOUT A CLIPPED HARNESS. ANCHOR YOUR LINE NOW.";else if(E?.behavior?.distracted)i="TRIGGER SCRIPT_DISTRACTION",t="AUDIO_LEVEL_2",d="EYES UP. PHONE DOWN. PAY ATTENTION TO THE FORKLIFT CROSSING.";else{i="TRIGGER AUDIO_LEVEL_1";let t=Array.isArray(e.analysis)?e.analysis.join(". "):e.analysis||"Safety violation detected";d=`SAFETY VIOLATION DETECTED. ${t}`}let p=[];p=Array.isArray(e.analysis)?e.analysis:"string"==typeof e.analysis?e.analysis.split(/\n|\. /).filter(e=>e.trim().length>0).map(e=>e.trim().replace(/^[-â€¢]\s*/,"")):["No issues detected"];let A={status:e.status||"ðŸŸ¢ CLEAR",detected:o,analysis:p.length>0?p:["No issues detected"],action:i,voiceOutput:d||"Area clear. Continue monitoring.",audioLevel:t,timestamp:new Date().toISOString()};return N.NextResponse.json(A)}catch(t){console.error("SITE GUARDIAN API error:",t);let e="Failed to analyze safety frame";return t.message&&(e+=`: ${t.message}`),t.message?.includes("API_KEY")?e="Invalid or missing Gemini API key. Please check your GEMINI_API_KEY environment variable.":(t.message?.includes("not found")||t.message?.includes("404"))&&(e=`Model "${g}" not available with your API key. Please update MODEL_NAME in src/app/api/analyze-safety/route.ts (line ~23) to one of: gemini-1.5-flash, gemini-1.5-pro, or gemini-pro. Visit /api/test-models to see which models are available. Error: ${t.message}`),N.NextResponse.json({error:e,details:t.message,suggestion:"Try using a different model name in the API route. Available models vary by API key access level."},{status:500})}}catch(e){return console.error("SITE GUARDIAN route error:",e),N.NextResponse.json({error:"Failed to analyze safety frame",details:e.message||"Unknown error"},{status:500})}}e.s(["POST",()=>C],73956);var S=e.i(73956);let v=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/analyze-safety/route",pathname:"/api/analyze-safety",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/analyze-safety/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:_,workUnitAsyncStorage:L,serverHooks:H}=v;function D(){return(0,r.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:L})}async function w(e,t,r){v.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let N="/api/analyze-safety/route";N=N.replace(/\/index$/,"")||"/";let T=await v.prepare(e,t,{srcPage:N,multiZoneDraftMode:!1});if(!T)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:O,params:m,nextConfig:y,parsedUrl:g,isDraftMode:C,prerenderManifest:S,routerServerContext:_,isOnDemandRevalidate:L,revalidateOnlyGenerated:H,resolvedPathname:D,clientReferenceManifest:w,serverActionsManifest:M}=T,b=(0,l.normalizeAppPath)(N),P=!!(S.dynamicRoutes[b]||S.routes[D]),G=async()=>((null==_?void 0:_.render404)?await _.render404(e,t,g,!1):t.end("This page could not be found"),null);if(P&&!C){let e=!!S.routes[D],t=S.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await G();throw new f.NoFallbackError}}let U=null;!P||v.isDev||C||(U="/index"===(U=D)?"/":U);let Y=!0===v.isDev||!P,x=P&&!Y;M&&w&&(0,n.setReferenceManifestsSingleton)({page:N,clientReferenceManifest:w,serverActionsManifest:M,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:M})});let k=e.method||"GET",V=(0,i.getTracer)(),B=V.getActiveScopeSpan(),F={params:m,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:Y,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>v.onRequestError(e,t,r,_)},sharedContext:{buildId:O}},W=new d.NodeNextRequest(e),z=new d.NodeNextResponse(t),Z=c.NextRequestAdapter.fromNodeNextRequest(W,(0,c.signalFromNodeResponse)(t));try{let n=async e=>v.handle(Z,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=V.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${k} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${N}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var i,l;let d=async({previousCacheEntry:a})=>{try{if(!s&&L&&H&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(o);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=F.renderOpts.collectedTags;if(!P)return await (0,p.sendResponse)(W,z,i,F.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,A.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[R.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:I.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await v.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:x,isOnDemandRevalidate:L})},_),t}},c=await v.handleResponse({req:e,nextConfig:y,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:L,revalidateOnlyGenerated:H,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:s});if(!P)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==I.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",L?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,A.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&P||u.delete(R.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(W,z,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};B?await l(B):await V.withPropagatedContext(e.headers,()=>V.trace(u.BaseServerSpan.handleRequest,{spanName:`${k} ${N}`,kind:i.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await v.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:x,isOnDemandRevalidate:L})}),P)throw t;return await (0,p.sendResponse)(W,z,new Response(null,{status:500})),null}}e.s(["handler",()=>w,"patchFetch",()=>D,"routeModule",()=>v,"serverHooks",()=>H,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>L],12374)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_2e01db4e.js.map