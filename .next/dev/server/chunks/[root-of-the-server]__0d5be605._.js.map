{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/stavansagala/Downloads/MadHacks%202025/src/app/api/analyze-video/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { GoogleGenerativeAI } from '@google/generative-ai';\n\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY || 'AIzaSyDjnsgbo5yc2iroteGTz5qVe0DvruZxS2M';\nconst genAI = new GoogleGenerativeAI(GEMINI_API_KEY);\n\nexport async function POST(request: NextRequest) {\n  try {\n    const formData = await request.formData();\n    const file = formData.get('video') as File | null;\n    const frameImage = formData.get('frame') as string | null; // Optional: base64 frame from client\n    \n    if (!file && !frameImage) {\n      return NextResponse.json({ error: 'No video file or frame provided' }, { status: 400 });\n    }\n\n    // Use Gemini Vision model\n    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });\n    \n    // For MVP, we'll analyze a frame from the video\n    // If frame is provided, use it; otherwise try to use the video file (limited size)\n    let imageData: string;\n    let mimeType: string;\n    let filename: string;\n\n    if (frameImage) {\n      // Use the extracted frame from client (preferred method)\n      imageData = frameImage.replace(/^data:image\\/\\w+;base64,/, '');\n      mimeType = 'image/jpeg';\n      filename = (file?.name || 'video_frame') + '.jpg';\n    } else if (file) {\n      // Fallback: try to use video file directly (for small files only)\n      // Note: Gemini 1.5 supports video, but images are more reliable\n      const arrayBuffer = await file.arrayBuffer();\n      const buffer = Buffer.from(arrayBuffer);\n      imageData = buffer.toString('base64');\n      mimeType = file.type || 'video/mp4';\n      filename = file.name;\n      \n      // If video is too large, reject it\n      if (file.size > 20 * 1024 * 1024) { // 20MB limit\n        return NextResponse.json({ \n          error: 'Video file too large. Please extract a frame on the client side or use a smaller video.' \n        }, { status: 400 });\n      }\n    } else {\n      return NextResponse.json({ error: 'No valid file or frame provided' }, { status: 400 });\n    }\n\n    // Analysis prompt\n    const prompt = `Analyze this ${frameImage ? 'video frame' : 'video'} for security threats, suspicious activities, or emergency situations such as:\n- Criminal activity or theft\n- Physical altercations or fights\n- Medical emergencies (fainting, choking, falls)\n- Suspicious behavior\n- Unauthorized access\n\nProvide a detailed analysis including:\n1. Any detected threats or emergencies (High/Medium/Low severity)\n2. Description of what you observe\n3. Recommended actions\n4. Confidence level of the detection\n\nRespond in JSON format with: {severity: \"High|Medium|Low|None\", description: \"...\", recommendations: \"...\", confidence: 0-100}`;\n\n    // Prepare the content part\n    const contentPart = {\n      inlineData: {\n        data: imageData,\n        mimeType: mimeType,\n      },\n    };\n\n    console.log('Sending to Gemini API...', { mimeType, size: imageData.length });\n    \n    try {\n      const result = await model.generateContent([prompt, contentPart]);\n      const response = await result.response;\n      const text = response.text();\n      console.log('Received response from Gemini');\n      \n      // Try to parse JSON from response\n      let analysis;\n      try {\n        // Extract JSON from markdown code blocks if present\n        const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n        if (jsonMatch) {\n          analysis = JSON.parse(jsonMatch[0]);\n        } else {\n          // Fallback: create structured response from text\n          analysis = {\n            severity: 'None',\n            description: text,\n            recommendations: 'Continue monitoring',\n            confidence: 50\n          };\n        }\n      } catch (parseError) {\n        console.error('Error parsing JSON response:', parseError);\n        // If parsing fails, create a structured response from text\n        const lowerText = text.toLowerCase();\n        analysis = {\n          severity: lowerText.includes('high') || lowerText.includes('threat') || lowerText.includes('emergency') ? 'High' : \n                    lowerText.includes('medium') || lowerText.includes('suspicious') ? 'Medium' : \n                    lowerText.includes('low') ? 'Low' : 'None',\n          description: text,\n          recommendations: 'Review the footage and take appropriate action',\n          confidence: 70\n        };\n      }\n\n      // Add timestamp and metadata\n      const result_data = {\n        ...analysis,\n        timestamp: new Date().toISOString(),\n        filename: file?.name || filename || 'unknown',\n        fileSize: file?.size || 0,\n        videoType: file?.type || mimeType,\n      };\n\n      return NextResponse.json(result_data);\n    } catch (geminiError: any) {\n      console.error('Gemini API error:', geminiError);\n      // Provide more detailed error message\n      let errorMessage = 'Failed to analyze video';\n      if (geminiError.message) {\n        errorMessage += `: ${geminiError.message}`;\n      }\n      if (geminiError.message?.includes('API_KEY')) {\n        errorMessage = 'Invalid or missing Gemini API key. Please check your GEMINI_API_KEY environment variable.';\n      }\n      return NextResponse.json(\n        { error: errorMessage, details: geminiError.message },\n        { status: 500 }\n      );\n    }\n  } catch (error: any) {\n    console.error('Error in analyze-video route:', error);\n    return NextResponse.json(\n      { error: 'Failed to analyze video', details: error.message || 'Unknown error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}